import window from"global/window";import videojs from"video.js";import dashjs from"dashjs";import document from"global/document";function find(e,t){for(let a=0;a<e.length;a++)if(t(e[a]))return e[a]}class Html5DashJS{constructor(e,t,a){a=a||t.options_;this.player=videojs(a.playerId);this.player.dash=this.player.dash||{};this.tech_=t;this.el_=t.el();this.elParent_=this.el_.parentNode;this.hasFiniteDuration_=!1;if(!e.src)return;t.isReady_=!1;if(Html5DashJS.updateSourceData){videojs.log.warn('updateSourceData has been deprecated. Please switch to using hook("updatesource", callback).');e=Html5DashJS.updateSourceData(e)}Html5DashJS.hooks("updatesource").forEach(t=>{e=t(e)});const r=e.src;this.keySystemOptions_=Html5DashJS.buildDashJSProtData(e.keySystemOptions);this.player.dash.mediaPlayer=dashjs.MediaPlayer().create();this.mediaPlayer_=this.player.dash.mediaPlayer;var s=this.mediaPlayer_,i=this.player,o=!1,n=0,l=[],d=-1;if(Html5DashJS.useVideoJSDebug)videojs.log.warn('useVideoJSDebug has been deprecated. Please switch to using hook("beforeinitialize", callback).');if(Html5DashJS.beforeInitialize){videojs.log.warn('beforeInitialize has been deprecated. Please switch to using hook("beforeinitialize", callback).');Html5DashJS.beforeInitialize(this.player,this.mediaPlayer_)}Html5DashJS.hooks("beforeinitialize").forEach(e=>{e(this.player,this.mediaPlayer_)});this.mediaPlayer_.initialize();this.retriggerError_=(e=>{if("capability"===e.error&&"mediasource"===e.event)this.player.error({code:4,message:"The media cannot be played because it requires a feature that your browser does not support."});else if("manifestError"===e.error&&("createParser"===e.event.id||"codec"===e.event.id||"nostreams"===e.event.id||"nostreamscomposed"===e.event.id||"parse"===e.event.id||"multiplexedrep"===e.event.id))this.player.error({code:4,message:e.event.message});else if("mediasource"===e.error)if(e.event.match("MEDIA_ERR_ABORTED"))this.player.error({code:1,message:e.event});else if(e.event.match("MEDIA_ERR_NETWORK"))this.player.error({code:2,message:e.event});else if(e.event.match("MEDIA_ERR_DECODE"))this.player.error({code:3,message:e.event});else if(e.event.match("MEDIA_ERR_SRC_NOT_SUPPORTED"))this.player.error({code:4,message:e.event});else if(e.event.match("MEDIA_ERR_ENCRYPTED"))this.player.error({code:5,message:e.event});else if(e.event.match("UNKNOWN"))this.player.error({code:4,message:e.event});else this.player.error({code:4,message:e.event});else if("capability"===e.error&&"encryptedmedia"===e.event)this.player.error({code:5,message:"The media cannot be played because it requires encryption features that your browser does not support."});else if("key_session"===e.error)this.player.error({code:5,message:e.event});else if("download"===e.error)this.player.error({code:2,message:"The media playback was aborted because too many consecutive download errors occurred."});else if("mssError"===e.error)this.player.error({code:3,message:e.event});else return;setTimeout(()=>{this.mediaPlayer_.reset()},10)});function c(e,t){const a=s,r=a.getTracksFor("audio"),o=i.audioTracks();function n(e){return`dash-audio-${e}`}function l(e,t){return e.find(({index:e})=>n(e)===t.id)}if(o.length)t.clearTracks(["audio"]);const d=a.getCurrentTrackFor("audio");r.forEach(t=>{let a,r;if(Array.isArray(t.labels))for(let r=0;r<t.labels.length;r++)if(t.labels[r].lang&&-1!==e.language().indexOf(t.labels[r].lang.toLowerCase())){a=t.labels[r];break}if(a)r=a.text;else if(Array.isArray(t.labels)&&1===t.labels.length)r=t.labels[0].text;else{r=t.lang;if(t.roles&&t.roles.length)r+=" ("+t.roles.join(", ")+")"}o.addTrack(new videojs.AudioTrack({enabled:t===d,id:n(t.index),kind:t.kind||"main",label:r,language:t.lang}))});const c=()=>{for(let e=0;e<o.length;e++){const t=o[e];if(!t.enabled);else{const e=l(r,t);a.setCurrentTrack(e)}}};o.addEventListener("change",c);s.on(dashjs.MediaPlayer.events.STREAM_TEARDOWN_COMPLETE,()=>{o.removeEventListener("change",c)})}this.mediaPlayer_.on(dashjs.MediaPlayer.events.PLAYBACK_METADATA_LOADED,c.bind(null,this.player,this.tech));function h(e,t,a){const r=[],o=a.map(t=>{let a,r;if(Array.isArray(t.labels))for(let r=0;r<t.labels.length;r++)if(t.labels[r].lang&&-1!==e.language().indexOf(t.labels[r].lang.toLowerCase())){a=t.labels[r];break}if(a)r=a.text;else if(Array.isArray(t.labels)&&1===t.labels.length)r=t.labels[0].text;else r=t.lang||t.label;return{dashTrack:t,trackConfig:{label:r,language:t.lang,srclang:t.lang,kind:t.kind}}}).map(({trackConfig:t,dashTrack:a})=>{if(a.isTTML&&!e.getChild("TTMLTextTrackDisplay"))return null;const s=e.addRemoteTextTrack(t,!1);r.push({textTrack:s.track,dashTrack:a});return s}).filter(e=>null!==e);function n(){const t=s,i=e.textTracks();let o=-1;for(let e=0;e<i.length;e+=1){const t=i[e];if("showing"===t.mode){const e=find(r,e=>e.textTrack===t),s=e?e.dashTrack:null;if(s)o=a.indexOf(s)}}if(o!==t.getCurrentTextTrackIndex())t.setTextTrack(o)}e.textTracks().on("change",n);e.on(dashjs.MediaPlayer.events.STREAM_TEARDOWN_COMPLETE,()=>{i.textTracks().off("change",n)});n();return o}if(window.VTTCue&&!/\[native code\]/.test(window.VTTCue.toString()))window.VTTCue=!1;let y=[];if(t.featuresNativeTextTracks){videojs.log.error("You must pass {html: {nativeCaptions: false}} in the videojs constructor to use text tracks in videojs-contrib-dash");return}const u=s;function f(){y.forEach(i.removeRemoteTextTrack.bind(i));y=[]}function p({index:e,tracks:t}){u.off(dashjs.MediaPlayer.events.TEXT_TRACKS_ADDED,p);f();if(t.length)y=h(this.player,this.tech,t,a)}this.mediaPlayer_.on(dashjs.MediaPlayer.events.TEXT_TRACKS_ADDED,p);this.mediaPlayer_.on(dashjs.MediaPlayer.events.CAN_PLAY,()=>{s.off(dashjs.MediaPlayer.events.TEXT_TRACKS_ADDED,p)});this.mediaPlayer_.on(dashjs.MediaPlayer.events.ERROR,this.retriggerError_);this.getDuration_=(e=>{const t=e.data.Period_asArray,a=this.hasFiniteDuration_;if(e.data.mediaPresentationDuration||t[t.length-1].duration)this.hasFiniteDuration_=!0;else this.hasFiniteDuration_=!1;if(this.hasFiniteDuration_!==a)this.player.trigger("durationchange")});this.mediaPlayer_.on(dashjs.MediaPlayer.events.MANIFEST_LOADED,this.getDuration_);this.mediaPlayer_.on(dashjs.MediaPlayer.events.PLAYBACK_ENDED,function(){clearInterval(n)});function m(){l=[];s.getBitrateInfoListFor("video").forEach(function(e){var t="vjs_"+e.qualityIndex,a={id:e.qualityIndex,index:t,label:t,width:e.width,height:e.height,bandwidth:e.bitrate,bitrate:e.bitrate,enabled:!1};l.push(a)})}this.mediaPlayer_.on(dashjs.MediaPlayer.events.PLAYBACK_STARTED,function(){if(!0!==o){o=!0;if(l.length<1)m();i.qualities=l;i.trigger("levelsLoaded");if(l.length>1){clearInterval(n);n=setInterval(function(){if(l.length>1){var e=s.getQualityFor("video");if(e!==d){d=e;var t=l[e].bitrate,a=l[e].height;i.trigger("qualityChange",{bitrate:t,height:a})}}},1e3)}}});this.mediaPlayer_.on(dashjs.MediaPlayer.events.STREAM_INITIALIZED,function(){m()});if(a.dash)this.mediaPlayer_.updateSettings(a.dash);this.mediaPlayer_.attachView(this.el_);if(a.dash&&a.dash.useTTML){this.ttmlContainer_=this.player.addChild("TTMLTextTrackDisplay");this.mediaPlayer_.attachTTMLRenderingDiv(this.ttmlContainer_.el())}this.mediaPlayer_.setAutoPlay(!1);this.mediaPlayer_.setProtectionData(this.keySystemOptions_);this.mediaPlayer_.attachSource(r);this.mediaPlayer_.initialize();this.mediaPlayer_.setAutoPlay(!1);this.tech_.triggerReady()}static buildDashJSProtData(e){if(!e)return null;else return e}dispose(){if(this.mediaPlayer_){this.mediaPlayer_.off(dashjs.MediaPlayer.events.ERROR,this.retriggerError_);this.mediaPlayer_.off(dashjs.MediaPlayer.events.MANIFEST_LOADED,this.getDuration_);this.mediaPlayer_.reset()}if(this.player.dash)delete this.player.dash;if(this.ttmlContainer_){this.ttmlContainer_.dispose();this.player.removeChild("TTMLTextTrackDisplay")}}duration(){if(this.mediaPlayer_.isDynamic()&&!this.hasFiniteDuration_)return 1/0;else return this.mediaPlayer_.duration()}static hooks(e,t){Html5DashJS.hooks_[e]=Html5DashJS.hooks_[e]||[];if(t)Html5DashJS.hooks_[e]=Html5DashJS.hooks_[e].concat(t);return Html5DashJS.hooks_[e]}static hook(e,t){Html5DashJS.hooks(e,t)}static removeHook(e,t){const a=Html5DashJS.hooks(e).indexOf(t);if(-1===a)return!1;Html5DashJS.hooks_[e]=Html5DashJS.hooks_[e].slice();Html5DashJS.hooks_[e].splice(a,1);return!0}}Html5DashJS.hooks_={};const canHandleKeySystems=function(e){e=JSON.parse(JSON.stringify(e));if(Html5DashJS.updateSourceData){videojs.log.warn('updateSourceData has been deprecated. Please switch to using hook("updatesource", callback).');e=Html5DashJS.updateSourceData(e)}Html5DashJS.hooks("updatesource").forEach(t=>{e=t(e)});const t=document.createElement("video");if(e.keySystemOptions&&!window.navigator.requestMediaKeySystemAccess&&!t.msSetMediaKeys)return!1;else return!0};videojs.DashSourceHandler=function(){return{canHandleSource(e){const t=/\.mpd/i;if(!canHandleKeySystems(e))return"";if(videojs.DashSourceHandler.canPlayType(e.type))return"probably";else if(t.test(e.src))return"maybe";return""},handleSource:(e,t,a)=>new Html5DashJS(e,t,a),canPlayType:e=>videojs.DashSourceHandler.canPlayType(e)}};videojs.DashSourceHandler.canPlayType=function(e){if(/^application\/dash\+xml/i.test(e))return"probably";else return""};if(window.MediaSource)videojs.getTech("Html5").registerSourceHandler(videojs.DashSourceHandler(),0);videojs.Html5DashJS=Html5DashJS;export default Html5DashJS;const Component=videojs.getComponent("Component"),darkGray="#222",lightGray="#ccc",fontMap={monospace:"monospace",sansSerif:"sans-serif",serif:"serif",monospaceSansSerif:'"Andale Mono", "Lucida Console", monospace',monospaceSerif:'"Courier New", monospace',proportionalSansSerif:"sans-serif",proportionalSerif:"serif",casual:'"Comic Sans MS", Impact, fantasy',script:'"Monotype Corsiva", cursive',smallcaps:'"Andale Mono", "Lucida Console", monospace, sans-serif'};function tryUpdateStyle(e,t,a){try{e.style[t]=a}catch(e){return}}function removeStyle(e){if(e.style){e.style.left=null;e.style.width="100%"}for(const t in e.children)removeStyle(e.children[t])}export function constructColor(e,t){let a;if(4===e.length)a=e[1]+e[1]+e[2]+e[2]+e[3]+e[3];else if(7===e.length)a=e.slice(1);else throw new Error("Invalid color code provided, "+e+"; must be formatted as e.g. #f0e or #f604e2.");return"rgba("+parseInt(a.slice(0,2),16)+","+parseInt(a.slice(2,4),16)+","+parseInt(a.slice(4,6),16)+","+t+")"};class TTMLTextTrackDisplay extends Component{constructor(e,t,a){super(e,videojs.mergeOptions(t,{playerOptions:{}}),a);const r=e.getChild("TextTrackSettings").$$("select");for(let e=0;e<r.length;e++)this.on(r[e],"change",this.updateStyle.bind(this));e.dash.mediaPlayer.on(dashjs.MediaPlayer.events.CAPTION_RENDERED,this.updateStyle.bind(this))}createEl(){const e=super.createEl("div",{className:"vjs-text-track-display-ttml"},{"aria-live":"off","aria-atomic":"true"});e.style.position="absolute";e.style.left="0";e.style.right="0";e.style.top="0";e.style.bottom="0";e.style.margin="1.5%";return e}updateStyle({captionDiv:e}){if(!this.player_.textTrackSettings)return;const t=this.player_.textTrackSettings.getValues();if(!(e=e||this.player_.getChild("TTMLTextTrackDisplay").el().firstChild))return;removeStyle(e);const a=e.getElementsByTagName("span");for(let e=0;e<a.length;e++){const r=a[e];r.parentNode.style.textAlign="center";if(t.color)r.style.color=t.color;if(t.textOpacity)tryUpdateStyle(r,"color",constructColor(t.color||"#fff",t.textOpacity));if(t.backgroundColor)r.style.backgroundColor=t.backgroundColor;if(t.backgroundOpacity)tryUpdateStyle(r,"backgroundColor",constructColor(t.backgroundColor||"#000",t.backgroundOpacity));if(t.windowColor)if(t.windowOpacity)tryUpdateStyle(r.parentNode,"backgroundColor",constructColor(t.windowColor,t.windowOpacity));else r.parent.style.backgroundColor=t.windowColor;if(t.edgeStyle)if("dropshadow"===t.edgeStyle)r.style.textShadow=`2px 2px 3px ${darkGray}, 2px 2px 4px ${darkGray}, 2px 2px 5px ${darkGray}`;else if("raised"===t.edgeStyle)r.style.textShadow=`1px 1px ${darkGray}, 2px 2px ${darkGray}, 3px 3px ${darkGray}`;else if("depressed"===t.edgeStyle)r.style.textShadow=`1px 1px ${lightGray}, 0 1px ${lightGray}, -1px -1px ${darkGray}, 0 -1px ${darkGray}`;else if("uniform"===t.edgeStyle)r.style.textShadow=`0 0 4px ${darkGray}, 0 0 4px ${darkGray}, 0 0 4px ${darkGray}, 0 0 4px ${darkGray}`;if(t.fontPercent&&1!==t.fontPercent){const e=window.parseFloat(r.style.fontSize);r.style.fontSize=e*t.fontPercent+"px";r.style.height="auto";r.style.top="auto";r.style.bottom="2px"}if(t.fontFamily&&"default"!==t.fontFamily)if("small-caps"===t.fontFamily)r.style.fontVariant="small-caps";else r.style.fontFamily=fontMap[t.fontFamily]}}}videojs.registerComponent("TTMLTextTrackDisplay",TTMLTextTrackDisplay);